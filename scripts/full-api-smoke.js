const { spawn } = require("child_process");
const path = require("path");
const bcrypt = require("bcryptjs");
const { PrismaClient } = require("@prisma/client");

const prisma = new PrismaClient();
const BASE_URL = process.env.SMOKE_BASE_URL || "http://localhost:5000/api/v1";
const ROOT_DIR = path.resolve(__dirname, "..");
const DEFAULT_PASSWORD = "Admin123!";

const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

function createError(message, details) {
  const error = new Error(message);
  error.details = details;
  return error;
}

async function waitForServer(timeoutMs = 20_000) {
  const startedAt = Date.now();
  while (Date.now() - startedAt < timeoutMs) {
    try {
      const res = await fetch(`${BASE_URL}/health`);
      if (res.ok) return;
    } catch {
      // retry
    }
    await sleep(500);
  }
  throw createError("Server did not become healthy in time");
}

async function api(pathname, options = {}) {
  const {
    method = "GET",
    token,
    body,
    expected = [200],
    name = `${method} ${pathname}`,
  } = options;

  const headers = { Accept: "application/json" };
  if (token) headers.Authorization = `Bearer ${token}`;
  if (body !== undefined) headers["Content-Type"] = "application/json";

  const response = await fetch(`${BASE_URL}${pathname}`, {
    method,
    headers,
    body: body !== undefined ? JSON.stringify(body) : undefined,
  });

  const raw = await response.text();
  let parsed;
  try {
    parsed = raw ? JSON.parse(raw) : null;
  } catch {
    parsed = raw;
  }

  if (!expected.includes(response.status)) {
    throw createError(`Failed: ${name}`, {
      status: response.status,
      body: parsed,
    });
  }

  console.log(`PASS  ${name} -> ${response.status}`);
  return parsed;
}

async function ensureTicket(schoolId, createdById) {
  const existing = await prisma.supportTicket.findFirst({
    where: { schoolId },
    orderBy: { createdAt: "desc" },
  });
  if (existing) return existing;

  return prisma.supportTicket.create({
    data: {
      schoolId,
      ticketNo: `TKT-${Date.now()}`,
      subject: "API Smoke Ticket",
      description: "Generated by full API smoke",
      priority: "MEDIUM",
      status: "OPEN",
      createdById: createdById || null,
    },
  });
}

async function ensureFaceCheckins(schoolId) {
  const records = [];
  for (let i = 0; i < 2; i += 1) {
    records.push(
      await prisma.faceCheckinLog.create({
        data: {
          schoolId,
          personType: "STAFF",
          personRefId: null,
          name: `Smoke Face ${Date.now()}-${i}`,
          location: "Main Gate",
          confidence: 88,
          status: "PENDING",
        },
      })
    );
  }
  return records;
}

async function createAuthSmokeUser(schoolId, suffix) {
  const email = `api_smoke_${suffix}@school.edu`;
  const passwordHash = await bcrypt.hash(DEFAULT_PASSWORD, 10);
  return prisma.user.create({
    data: {
      fullName: "API Smoke Auth User",
      email,
      passwordHash,
      role: "TEACHER",
      schoolId,
      isActive: true,
    },
  });
}

async function run() {
  const suffix = Date.now().toString();
  const state = {};
  let serverProcess = null;
  let startedByScript = false;

  try {
    try {
      await waitForServer(2_000);
      console.log("Using existing running server");
    } catch {
      startedByScript = true;
      serverProcess = spawn("node", ["src/server.js"], {
        cwd: ROOT_DIR,
        stdio: "ignore",
      });
      await waitForServer();
      console.log("Started local server");
    }

    const superLogin = await api("/auth/login", {
      method: "POST",
      body: { email: "super@school.edu", password: DEFAULT_PASSWORD },
      expected: [200],
      name: "POST /auth/login super",
    });
    state.super = superLogin.data;

    const adminLogin = await api("/auth/login", {
      method: "POST",
      body: { email: "admin@school.edu", password: DEFAULT_PASSWORD },
      expected: [200],
      name: "POST /auth/login admin",
    });
    state.admin = adminLogin.data;
    state.schoolId = adminLogin.data.user.schoolId;

    await api("/auth/me", { token: state.admin.accessToken, expected: [200], name: "GET /auth/me" });
    await api("/auth/refresh", {
      method: "POST",
      body: { refreshToken: state.admin.refreshToken },
      expected: [200],
      name: "POST /auth/refresh",
    });

    state.authUser = await createAuthSmokeUser(state.schoolId, suffix);
    await api("/auth/forgot-password", {
      method: "POST",
      body: { email: state.authUser.email },
      expected: [200],
      name: "POST /auth/forgot-password",
    });

    const otp = "654321";
    await prisma.passwordResetOtp.updateMany({
      where: { email: state.authUser.email, usedAt: null },
      data: { usedAt: new Date() },
    });
    await prisma.passwordResetOtp.create({
      data: {
        email: state.authUser.email,
        otpHash: await bcrypt.hash(otp, 10),
        expiresAt: new Date(Date.now() + 5 * 60 * 1000),
      },
    });

    const otpVerify = await api("/auth/verify-otp", {
      method: "POST",
      body: { email: state.authUser.email, otp },
      expected: [200],
      name: "POST /auth/verify-otp",
    });
    const resetPassword = "NewPass123!";
    await api("/auth/reset-password", {
      method: "POST",
      body: { resetToken: otpVerify.data.resetToken, newPassword: resetPassword },
      expected: [200],
      name: "POST /auth/reset-password",
    });
    const authRelogin = await api("/auth/login", {
      method: "POST",
      body: { email: state.authUser.email, password: resetPassword },
      expected: [200],
      name: "POST /auth/login auth-smoke-user",
    });
    await api("/auth/change-password", {
      method: "POST",
      token: authRelogin.data.accessToken,
      body: { currentPassword: resetPassword, newPassword: DEFAULT_PASSWORD },
      expected: [200],
      name: "POST /auth/change-password",
    });
    await api("/auth/logout", {
      method: "POST",
      body: { refreshToken: authRelogin.data.refreshToken },
      expected: [200],
      name: "POST /auth/logout",
    });

    await api("/dashboard/school-admin", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /dashboard/school-admin",
    });
    await api("/dashboard/hr", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /dashboard/hr",
    });
    await api("/dashboard/accountant", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /dashboard/accountant",
    });

    await api("/superadmin/dashboard/overview", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/dashboard/overview",
    });
    await api("/superadmin/schools", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/schools",
    });

    const createdSchool = await api("/superadmin/schools", {
      method: "POST",
      token: state.super.accessToken,
      body: {
        code: `SMK-${suffix.slice(-6)}`,
        name: `Smoke School ${suffix.slice(-4)}`,
        email: `smoke_${suffix}@school.edu`,
        phone: "9999999999",
      },
      expected: [201],
      name: "POST /superadmin/schools",
    });
    state.createdSchoolId = createdSchool.data.school.id;

    await api(`/superadmin/schools/${state.createdSchoolId}`, {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/schools/:id",
    });
    await api(`/superadmin/schools/${state.createdSchoolId}`, {
      method: "PUT",
      token: state.super.accessToken,
      body: { name: `Smoke School Updated ${suffix.slice(-4)}` },
      expected: [200],
      name: "PUT /superadmin/schools/:id",
    });
    await api(`/superadmin/schools/${state.createdSchoolId}/status`, {
      method: "PATCH",
      token: state.super.accessToken,
      body: { status: "PENDING" },
      expected: [200],
      name: "PATCH /superadmin/schools/:id/status",
    });

    await api("/superadmin/subscriptions", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/subscriptions",
    });
    await api(`/superadmin/subscriptions/${state.schoolId}/plan`, {
      method: "PATCH",
      token: state.super.accessToken,
      body: { planCode: "PRO" },
      expected: [200],
      name: "PATCH /superadmin/subscriptions/:schoolId/plan",
    });
    await api(`/superadmin/subscriptions/${state.schoolId}/auto-renew`, {
      method: "PATCH",
      token: state.super.accessToken,
      body: { autoRenew: true },
      expected: [200],
      name: "PATCH /superadmin/subscriptions/:schoolId/auto-renew",
    });

    await api("/superadmin/plans", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/plans",
    });
    await api("/superadmin/plans/BASIC", {
      method: "PUT",
      token: state.super.accessToken,
      body: { priceMonthly: 65 },
      expected: [200],
      name: "PUT /superadmin/plans/:planCode",
    });

    await api("/superadmin/configuration", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/configuration",
    });
    await api("/superadmin/configuration", {
      method: "PUT",
      token: state.super.accessToken,
      body: { supportPhone: "+1-555-1212", maintenanceMode: false },
      expected: [200],
      name: "PUT /superadmin/configuration",
    });

    state.ticket = await ensureTicket(state.schoolId, state.admin.user.id);
    await api("/superadmin/support/tickets", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/support/tickets",
    });
    await api(`/superadmin/support/tickets/${state.ticket.id}`, {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/support/tickets/:id",
    });
    await api(`/superadmin/support/tickets/${state.ticket.id}/replies`, {
      method: "POST",
      token: state.super.accessToken,
      body: { message: "Smoke reply from superadmin" },
      expected: [201],
      name: "POST /superadmin/support/tickets/:id/replies",
    });
    await api(`/superadmin/support/tickets/${state.ticket.id}/status`, {
      method: "PATCH",
      token: state.super.accessToken,
      body: { status: "RESOLVED" },
      expected: [200],
      name: "PATCH /superadmin/support/tickets/:id/status",
    });
    await api("/superadmin/analytics/overview", {
      token: state.super.accessToken,
      expected: [200],
      name: "GET /superadmin/analytics/overview",
    });

    await api("/school/students", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/students",
    });

    const staff = await api("/school/staff", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        employeeCode: `EMP-${suffix.slice(-6)}`,
        fullName: "Smoke Staff",
        email: `staff_${suffix}@school.edu`,
        phone: "9999999999",
        designation: "Teacher",
        department: "Academics",
      },
      expected: [201],
      name: "POST /school/staff",
    });
    state.staffId = staff.data.staff.id;

    const classRoom = await api("/school/classes", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        name: "10",
        section: `S${suffix.slice(-2)}`,
        classTeacherId: state.staffId,
        capacity: 40,
      },
      expected: [201],
      name: "POST /school/classes",
    });
    state.classId = classRoom.data.classRoom.id;

    const subject = await api("/school/subjects", {
      method: "POST",
      token: state.admin.accessToken,
      body: { name: "Mathematics", code: `MATH-${suffix.slice(-4)}` },
      expected: [201],
      name: "POST /school/subjects",
    });
    state.subjectId = subject.data.subject.id;

    const student = await api("/school/students", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        classId: state.classId,
        admissionNo: `ADM-${suffix.slice(-6)}`,
        firstName: "Ava",
        lastName: "Singh",
        className: "10",
        section: "A",
        guardianPhone: "9999999999",
      },
      expected: [201],
      name: "POST /school/students (create)",
    });
    state.studentId = student.data.student.id;

    await api(`/school/students/${state.studentId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/students/:id",
    });
    await api(`/school/students/${state.studentId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { section: "B", rollNo: 5 },
      expected: [200],
      name: "PUT /school/students/:id",
    });
    await api(`/school/students/${state.studentId}/status`, {
      method: "PATCH",
      token: state.admin.accessToken,
      body: { status: "ACTIVE" },
      expected: [200],
      name: "PATCH /school/students/:id/status",
    });

    const document = await api(`/school/students/${state.studentId}/documents`, {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        name: "Birth Certificate",
        url: "https://example.com/doc.pdf",
        type: "CERTIFICATE",
        sizeKb: 100,
      },
      expected: [201],
      name: "POST /school/students/:id/documents",
    });
    state.documentId = document.data.document.id;
    await api(`/school/students/${state.studentId}/documents/${state.documentId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/students/:id/documents/:docId",
    });

    await api("/school/parents", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/parents",
    });
    const parentInvite = await api("/school/parents/invite", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        fullName: "Smoke Parent",
        email: `parent_${suffix}@gmail.com`,
        phone: "9999999998",
        studentId: state.studentId,
        relationType: "MOTHER",
        isPrimary: true,
      },
      expected: [201],
      name: "POST /school/parents/invite",
    });
    state.parentId = parentInvite.data.parent.id;
    await api(`/school/parents/${state.parentId}/resend-otp`, {
      method: "POST",
      token: state.admin.accessToken,
      body: {},
      expected: [200],
      name: "POST /school/parents/:id/resend-otp",
    });

    await api("/school/staff", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/staff",
    });
    await api(`/school/staff/${state.staffId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { designation: "Senior Teacher" },
      expected: [200],
      name: "PUT /school/staff/:id",
    });
    await api("/school/classes", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/classes",
    });
    await api(`/school/classes/${state.classId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { capacity: 45 },
      expected: [200],
      name: "PUT /school/classes/:id",
    });
    await api("/school/subjects", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/subjects",
    });
    await api(`/school/subjects/${state.subjectId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { name: "Advanced Mathematics" },
      expected: [200],
      name: "PUT /school/subjects/:id",
    });

    await api("/school/attendance/overview", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/attendance/overview",
    });
    await api("/school/attendance/mark", {
      method: "POST",
      token: state.admin.accessToken,
      body: { type: "student", studentId: state.studentId, status: "PRESENT" },
      expected: [200],
      name: "POST /school/attendance/mark student",
    });
    await api("/school/attendance/mark", {
      method: "POST",
      token: state.admin.accessToken,
      body: { type: "staff", staffId: state.staffId, status: "LEAVE", remark: "Medical leave" },
      expected: [200],
      name: "POST /school/attendance/mark staff",
    });
    await api("/school/attendance/bulk-mark", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        type: "student",
        records: [{ studentId: state.studentId, status: "PRESENT", remark: "On time" }],
      },
      expected: [200],
      name: "POST /school/attendance/bulk-mark",
    });

    await api("/school/timetable", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/timetable",
    });
    const slot = await api("/school/timetable/slots", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        classId: state.classId,
        subjectId: state.subjectId,
        teacherId: state.staffId,
        title: "Math Period",
        platform: "OFFLINE",
        startsAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
      },
      expected: [201],
      name: "POST /school/timetable/slots",
    });
    state.slotId = slot.data.slot.id;
    await api(`/school/timetable/slots/${state.slotId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { title: "Updated Math Period" },
      expected: [200],
      name: "PUT /school/timetable/slots/:id",
    });
    await api("/school/timetable/publish", {
      method: "POST",
      token: state.admin.accessToken,
      body: { classId: state.classId },
      expected: [200],
      name: "POST /school/timetable/publish",
    });

    await api("/school/fees/summary", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/fees/summary",
    });
    await api("/school/fees/structures", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/fees/structures",
    });
    const feeStructure = await api("/school/fees/structures", {
      method: "POST",
      token: state.admin.accessToken,
      body: { name: `Tuition-${suffix.slice(-4)}`, amount: 2500, frequency: "MONTHLY" },
      expected: [201],
      name: "POST /school/fees/structures",
    });
    state.feeStructureId = feeStructure.data.feeStructure.id;
    await api(`/school/fees/structures/${state.feeStructureId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { amount: 2600 },
      expected: [200],
      name: "PUT /school/fees/structures/:id",
    });

    await api("/school/invoices", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/invoices",
    });
    const invoice = await api("/school/invoices", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        studentId: state.studentId,
        feeStructureId: state.feeStructureId,
        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
        amountDue: 2600,
      },
      expected: [201],
      name: "POST /school/invoices",
    });
    state.invoiceId = invoice.data.invoice.id;
    await api(`/school/invoices/${state.invoiceId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/invoices/:id",
    });
    await api(`/school/invoices/${state.invoiceId}/status`, {
      method: "PATCH",
      token: state.admin.accessToken,
      body: { status: "ISSUED" },
      expected: [200],
      name: "PATCH /school/invoices/:id/status",
    });

    await api("/school/payments", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/payments",
    });
    const payment = await api("/school/payments", {
      method: "POST",
      token: state.admin.accessToken,
      body: { studentId: state.studentId, invoiceId: state.invoiceId, amount: 1000, method: "CASH" },
      expected: [201],
      name: "POST /school/payments",
    });
    state.paymentId = payment.data.payment.id;
    await api(`/school/payments/${state.paymentId}/receipt`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/payments/:id/receipt",
    });

    await api("/school/announcements", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/announcements",
    });
    const announcement = await api("/school/announcements", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        title: "Holiday Notice",
        content: "Tomorrow holiday due to local event.",
        audience: "ALL",
      },
      expected: [201],
      name: "POST /school/announcements",
    });
    state.announcementId = announcement.data.announcement.id;
    await api(`/school/announcements/${state.announcementId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { content: "Tomorrow holiday due to weather." },
      expected: [200],
      name: "PUT /school/announcements/:id",
    });
    await api(`/school/announcements/${state.announcementId}/send`, {
      method: "POST",
      token: state.admin.accessToken,
      body: {},
      expected: [200],
      name: "POST /school/announcements/:id/send",
    });

    await api("/school/reports/jobs", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/reports/jobs",
    });
    await api("/school/reports/generate", {
      method: "POST",
      token: state.admin.accessToken,
      body: { type: "FEE_COLLECTION" },
      expected: [201],
      name: "POST /school/reports/generate",
    });

    await api("/school/audit-logs", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/audit-logs",
    });
    await api("/school/settings", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/settings",
    });
    await api("/school/settings", {
      method: "PUT",
      token: state.admin.accessToken,
      body: { timezone: "Asia/Kolkata", currencyCode: "INR" },
      expected: [200],
      name: "PUT /school/settings",
    });

    await api("/school/roles", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/roles",
    });
    const role = await api("/school/roles", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        name: "Transport Manager",
        description: "Transport operations",
        permissions: ["transport.view", "transport.manage"],
      },
      expected: [201],
      name: "POST /school/roles",
    });
    state.roleId = role.data.role.id;
    await api(`/school/roles/${state.roleId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { permissions: ["transport.view"] },
      expected: [200],
      name: "PUT /school/roles/:id",
    });

    const faceRecords = await ensureFaceCheckins(state.schoolId);
    await api("/school/face-checkins", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/face-checkins",
    });
    await api(`/school/face-checkins/${faceRecords[0].id}/approve`, {
      method: "PATCH",
      token: state.admin.accessToken,
      body: { reason: "Verified identity" },
      expected: [200],
      name: "PATCH /school/face-checkins/:id/approve",
    });
    await api(`/school/face-checkins/${faceRecords[1].id}/reject`, {
      method: "PATCH",
      token: state.admin.accessToken,
      body: { reason: "Low confidence" },
      expected: [200],
      name: "PATCH /school/face-checkins/:id/reject",
    });

    await api("/school/ai/faqs", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/ai/faqs",
    });
    const faq = await api("/school/ai/faqs", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        question: "How to pay fees?",
        answer: "Go to fees section and choose invoice.",
        category: "Fees",
      },
      expected: [201],
      name: "POST /school/ai/faqs",
    });
    state.faqId = faq.data.faq.id;
    await api(`/school/ai/faqs/${state.faqId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { isPublished: true },
      expected: [200],
      name: "PUT /school/ai/faqs/:id",
    });

    await api("/school/live-classes/sessions", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/live-classes/sessions",
    });
    const liveSession = await api("/school/live-classes/sessions", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        classId: state.classId,
        subjectId: state.subjectId,
        teacherId: state.staffId,
        title: "Live Math Class",
        platform: "Google Meet",
        joinUrl: "https://meet.google.com/abc-smoke",
        startsAt: new Date(Date.now() + 60 * 60 * 1000).toISOString(),
      },
      expected: [201],
      name: "POST /school/live-classes/sessions",
    });
    state.liveSessionId = liveSession.data.session.id;
    await api(`/school/live-classes/sessions/${state.liveSessionId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { title: "Updated Live Math Class" },
      expected: [200],
      name: "PUT /school/live-classes/sessions/:id",
    });
    await api(`/school/live-classes/sessions/${state.liveSessionId}/end`, {
      method: "POST",
      token: state.admin.accessToken,
      body: {},
      expected: [200],
      name: "POST /school/live-classes/sessions/:id/end",
    });

    await api("/school/exams", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /school/exams",
    });
    const exam = await api("/school/exams", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        classId: state.classId,
        subjectId: state.subjectId,
        name: "Unit Test 1",
        examDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
        maxMarks: 100,
      },
      expected: [201],
      name: "POST /school/exams",
    });
    state.examId = exam.data.exam.id;
    await api(`/school/exams/${state.examId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { name: "Unit Test 1 - Updated" },
      expected: [200],
      name: "PUT /school/exams/:id",
    });
    await api(`/school/exams/${state.examId}/marks`, {
      method: "POST",
      token: state.admin.accessToken,
      body: { results: [{ studentId: state.studentId, marks: 88, grade: "A", remarks: "Good" }] },
      expected: [200],
      name: "POST /school/exams/:id/marks",
    });
    await api(`/school/exams/${state.examId}/publish`, {
      method: "POST",
      token: state.admin.accessToken,
      body: {},
      expected: [200],
      name: "POST /school/exams/:id/publish",
    });

    await api("/hr/dashboard/overview", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/dashboard/overview",
    });
    await api("/hr/staff", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/staff",
    });
    await api(`/hr/staff/${state.staffId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/staff/:id",
    });

    const leaveList = await api("/hr/leave-requests", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/leave-requests",
    });
    const leaveId = leaveList.data.items[0]?.id;
    if (!leaveId) {
      throw createError("No leave request found after staff leave mark");
    }
    await api(`/hr/leave-requests/${leaveId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/leave-requests/:id",
    });
    await api(`/hr/leave-requests/${leaveId}/status`, {
      method: "PATCH",
      token: state.admin.accessToken,
      body: { status: "APPROVED", note: "Approved by API smoke" },
      expected: [200],
      name: "PATCH /hr/leave-requests/:id/status",
    });
    await api(`/hr/leave-requests/${leaveId}/comment`, {
      method: "POST",
      token: state.admin.accessToken,
      body: { comment: "Please upload docs if required." },
      expected: [201],
      name: "POST /hr/leave-requests/:id/comment",
    });
    await api("/hr/attendance/performance", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/attendance/performance",
    });
    await api(`/hr/attendance/performance/${state.staffId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/attendance/performance/:staffId",
    });
    await api("/hr/settings", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/settings",
    });
    await api("/hr/settings", {
      method: "PUT",
      token: state.admin.accessToken,
      body: { approvalLevels: 2, allowSelfAttendanceRegularization: true, probationMonths: 4 },
      expected: [200],
      name: "PUT /hr/settings",
    });
    await api("/hr/roles", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /hr/roles",
    });
    await api("/hr/roles/TEACHER", {
      method: "PUT",
      token: state.admin.accessToken,
      body: { permissions: ["attendance.mark", "students.view", "results.publish"], isActive: true },
      expected: [200],
      name: "PUT /hr/roles/:id",
    });

    await api("/accountant/dashboard/overview", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/dashboard/overview",
    });
    await api("/accountant/fees/structures", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/fees/structures",
    });
    const accFee = await api("/accountant/fees/structures", {
      method: "POST",
      token: state.admin.accessToken,
      body: { name: `Exam Fee-${suffix.slice(-4)}`, amount: 500, frequency: "ONCE" },
      expected: [201],
      name: "POST /accountant/fees/structures",
    });
    state.accFeeId = accFee.data.feeStructure.id;
    await api(`/accountant/fees/structures/${state.accFeeId}`, {
      method: "PUT",
      token: state.admin.accessToken,
      body: { amount: 550 },
      expected: [200],
      name: "PUT /accountant/fees/structures/:id",
    });

    await api("/accountant/invoices", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/invoices",
    });
    const accInvoice = await api("/accountant/invoices", {
      method: "POST",
      token: state.admin.accessToken,
      body: {
        studentId: state.studentId,
        dueDate: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(),
        amountDue: 550,
        feeStructureId: state.accFeeId,
      },
      expected: [201],
      name: "POST /accountant/invoices",
    });
    state.accInvoiceId = accInvoice.data.invoice.id;
    await api(`/accountant/invoices/${state.accInvoiceId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/invoices/:id",
    });
    await api(`/accountant/invoices/${state.accInvoiceId}/status`, {
      method: "PATCH",
      token: state.admin.accessToken,
      body: { status: "ISSUED" },
      expected: [200],
      name: "PATCH /accountant/invoices/:id/status",
    });

    await api("/accountant/payments", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/payments",
    });
    const accPayment = await api("/accountant/payments", {
      method: "POST",
      token: state.admin.accessToken,
      body: { studentId: state.studentId, invoiceId: state.accInvoiceId, amount: 300, method: "UPI" },
      expected: [201],
      name: "POST /accountant/payments",
    });
    state.accPaymentId = accPayment.data.payment.id;
    await api(`/accountant/payments/${state.accPaymentId}`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/payments/:id",
    });
    await api(`/accountant/payments/${state.accPaymentId}/receipt`, {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/payments/:id/receipt",
    });
    await api("/accountant/students/balances", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/students/balances",
    });
    await api("/accountant/reports/jobs", {
      token: state.admin.accessToken,
      expected: [200],
      name: "GET /accountant/reports/jobs",
    });
    await api("/accountant/reports/generate", {
      method: "POST",
      token: state.admin.accessToken,
      body: { type: "OUTSTANDING_BALANCE" },
      expected: [201],
      name: "POST /accountant/reports/generate",
    });

    await api(`/school/timetable/slots/${state.slotId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/timetable/slots/:id",
    });
    await api(`/school/ai/faqs/${state.faqId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/ai/faqs/:id",
    });
    await api(`/school/announcements/${state.announcementId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/announcements/:id",
    });
    await api(`/school/exams/${state.examId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/exams/:id",
    });
    await api(`/school/roles/${state.roleId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/roles/:id",
    });
    await api(`/accountant/fees/structures/${state.accFeeId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /accountant/fees/structures/:id",
    });
    await api(`/school/fees/structures/${state.feeStructureId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/fees/structures/:id",
    });
    await api(`/school/classes/${state.classId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/classes/:id",
    });
    await api(`/school/subjects/${state.subjectId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/subjects/:id",
    });
    await api(`/school/staff/${state.staffId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/staff/:id",
    });
    await api(`/school/students/${state.studentId}`, {
      method: "DELETE",
      token: state.admin.accessToken,
      expected: [200],
      name: "DELETE /school/students/:id",
    });
    await api(`/superadmin/schools/${state.createdSchoolId}`, {
      method: "DELETE",
      token: state.super.accessToken,
      expected: [200],
      name: "DELETE /superadmin/schools/:id",
    });

    console.log("\nALL CHECKS PASSED: full API smoke run completed.");
  } finally {
    const authUserId = state.authUser?.id;
    const started = startedByScript;
    const processRef = serverProcess;
    if (authUserId) {
      try {
        await prisma.user.delete({ where: { id: authUserId } });
      } catch {
        // ignore cleanup errors
      }
    }

    await prisma.$disconnect();

    if (started && processRef && !processRef.killed) {
      processRef.kill("SIGTERM");
    }
  }
}

run().catch((error) => {
  console.error("\nSMOKE RUN FAILED");
  console.error(error.message);
  if (error.details) {
    console.error(JSON.stringify(error.details, null, 2));
  }
  process.exit(1);
});
